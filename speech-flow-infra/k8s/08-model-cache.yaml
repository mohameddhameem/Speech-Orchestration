---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: speech-flow-models
  namespace: speech-flow
  labels:
    app: speech-flow
    component: model-cache
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: azurefile
---
apiVersion: batch/v1
kind: Job
metadata:
  name: preload-models
  namespace: speech-flow
  labels:
    app: speech-flow
    component: model-preloader
spec:
  template:
    metadata:
      labels:
        app: speech-flow
        component: model-preloader
    spec:
      restartPolicy: OnFailure
      containers:
      - name: preloader
        image: ${CONTAINER_REGISTRY}/speech-flow-workers:${IMAGE_TAG}
        command:
        - python
        - common/preload_models.py
        args:
        - --all
        - --cache-dir
        - /models
        env:
        - name: MODEL_CACHE_DIR
          value: /models
        - name: WHISPER_MODEL_NAME
          value: large-v3
        - name: WHISPER_DEVICE
          value: cpu
        - name: WHISPER_COMPUTE_TYPE
          value: float16
        - name: LID_MODEL_ID
          value: facebook/mms-lid-126
        - name: LID_MODEL_REVISION
          value: main
        - name: MODEL_DOWNLOAD_MAX_RETRIES
          value: '5'
        - name: MODEL_DOWNLOAD_RETRY_DELAY
          value: '10'
        volumeMounts:
        - name: models
          mountPath: /models
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 4Gi
      volumes:
      - name: models
        persistentVolumeClaim:
          claimName: speech-flow-models
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: update-models
  namespace: speech-flow
  labels:
    app: speech-flow
    component: model-updater
spec:
  schedule: 0 2 * * 0
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: speech-flow
            component: model-updater
        spec:
          restartPolicy: OnFailure
          containers:
          - name: updater
            image: ${CONTAINER_REGISTRY}/speech-flow-workers:${IMAGE_TAG}
            command:
            - python
            - common/preload_models.py
            args:
            - --all
            - --cache-dir
            - /models
            env:
            - name: MODEL_CACHE_DIR
              value: /models
            - name: MODEL_DOWNLOAD_MAX_RETRIES
              value: '5'
            volumeMounts:
            - name: models
              mountPath: /models
            resources:
              requests:
                cpu: 500m
                memory: 2Gi
              limits:
                cpu: 2000m
                memory: 4Gi
          volumes:
          - name: models
            persistentVolumeClaim:
              claimName: speech-flow-models
